name: vntapp-Linux

on:
   workflow_dispatch:
    inputs:
      repo:
        description: '请输入vntAPP源码仓库'
        required: true
        default: 'cn1095/VntApp'
      tag:
        description: '请输入仓库分支或版本号'
        required: true
        default: 'Location'
env:
  CARGO_TERM_COLOR: always
  TZ: Asia/Shanghai
  repo: "${{ github.event.inputs.repo }}"
  tag: "${{ github.event.inputs.tag }}"
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 设置Flutter环境
        uses: subosito/flutter-action@v2
        with:
         channel: stable
         flutter-version: 3.22.0
         
      - name: 克隆源码
        run: git clone -b "${{ env.tag }}" "https://github.com/${{ env.repo }}" /opt/vnt
           
      - name: 构建
        run: |
         cd /opt/vnt
         sudo apt-get update
         sudo apt-get install -y libgtk-3-dev build-essential libayatana-appindicator3-dev --fix-missing
         flutter pub get
         flutter build linux --release -v
         
         #mkdir -p /opt/vntAPP
         #mv -f /opt/vnt/build/linux/x64/release/bundle /opt/vntAPP/vntAPP-Linux-x86_64

      - name: 打包 AppImage
        env:
          VERSION: 1.2.16
        run: |
          cd /opt/vnt
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          mkdir -p vntAPP/usr/bin
          cp -r build/linux/x86_64/release/bundle/* vntAPP/usr/bin/
          cp assets/app_icon.png vntAPP/
          cp assets/vnt.desktop vntAPP/
          ./appimagetool-x86_64.AppImage vntAPP
    
      - name : 上传
        uses: actions/upload-artifact@master
        if: always()
        with:
         name: vntAPP-Linux
         path: /opt/vnt/*.AppImage
